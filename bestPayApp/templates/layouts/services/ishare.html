{% extends 'base.html' %}
{% load static %}
{% block title %} Flexi Bundles - BestPay {% endblock %}
{% block content %}

  <!-- Back to top button -->
  <div class="back-to-top"></div>

  <header>
    {% include 'inc/navbar.html' %}

    <div class="container mt-5">
      <div class="page-banner">
        <div class="row justify-content-center align-items-center h-100">
          <div class="col-md-6">
            <nav aria-label="Breadcrumb">
              <ul class="breadcrumb justify-content-center py-0 bg-transparent">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                <li class="breadcrumb-item active"><a href="{% url 'services' %}">Services</a></li>
                <li class="breadcrumb-item active"><a href="{% url 'bundle' %}">Bundles</a></li>
                <li class="breadcrumb-item active"><a href="{% url 'bundle' %}">AirtelTigo</a></li>
                <li class="breadcrumb-item active">Flexi Bundles</li>
              </ul>
            </nav>
            <h1 style="color: #8e8aad" class="text-center">Buy Flexi Bundles and Browse Saaaaaaa</h1>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="page-section">
        <div class="container">
            {% for error in form.non_field_errors %}
                <small style="display: block; color: red">{{ error }}</small>
            {% endfor %}
            <form id="paymentForm">
                {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label> Phone Number </label>
                            {{ form.phone_number }}
                            <small>E.g. 02XXXXXXXX"</small>
                        </div>
                        <div class="form-group col-md-6">
                            <label> Choose Offer </label>
                            {{ form.offers }}
                        </div>

                        <input class="email" type="hidden" value="{{ email }}">
                        <input class="reference" type="hidden" value="{{ ref }}">

                        <div class="col-md-12">
                          <p>Pay with</p>
                          <img src="{% static 'img/services/momo-fig.png' %}" alt=""> <span style="color: #383838">||</span>
                          <img src="{% static 'img/services/atm-fig.png' %}" alt=""> <span style="color: #383838">||</span>
                          <img src="{% static 'img/services/voca-fig.png' %}" alt=""> <span style="color: #383838">||</span>
                          <img src="{% static 'img/services/vima-fig.png' %}" alt="">
                        </div>
                        <button onclick="payWithPaystack()" class="btn btn-outline-primary my-3 checkout">Checkout</button>
                    </div>
            </form>
        </div>
    </div>   <!-- .page-section -->
  </main>

{% include 'inc/footer.html' %}

{% endblock %}

{% block scripts %}
    <script>
        const paymentForm = document.getElementById('paymentForm');
        let email = $(".email").val()
        let ref = $(".reference").val()
        console.log(email + ref)
        paymentForm.addEventListener("submit", payWithPaystack, false);
        function payWithPaystack(e) {
            e.preventDefault();
            $('.checkout').prop('disabled', true);
            let r_amount = ""
            let amount = $(".i-offer").val()
            console.log(amount)
            if (amount >=1 && amount <=50){
                r_amount = parseFloat(amount) + 0.5
                console.log(r_amount)
            }else{
                let percentage = ((0.01)*parseFloat(amount))
                r_amount = parseFloat(amount) + percentage
                console.log(r_amount)
            }
            let phonenumber = $(".phone").val()
            if (phonenumber.toString().length < 10 || phonenumber.toString().length != 10 || phonenumber.toString().length > 10){
              Swal.fire({text: "Phone number must be 10 digits"})
              $('.checkout').prop('disabled', false);
              return;
            }

            let token = $("input[name=csrfmiddlewaretoken]").val();

            $.ajax({
              url: '/save_details/',
              method: "POST",
              data: {
                phone: phonenumber,
                amount: amount,
                ref: ref,
                csrfmiddlewaretoken: token,
              },
              success: function(response){
                Swal.showLoading()
                Swal.fire({text: "Click Pay to initiate payment.", confirmButtonText: "Pay", cancelButtonText: 'Cancel', showCancelButton: true,allowOutsideClick: false,
allowEscapeKey: false,}).then((result) => {
                  if (result.isConfirmed){
                      let handler = PaystackPop.setup({
                    key: 'pk_live_99e10d6f2512390f0960dbf9ac3a8163af13e275', // Replace with your public key
                    email: email,
                    amount: r_amount * 100,
                    currency: "GHS",
                    ref: ref, // generates a pseudo-unique reference. Please replace with a reference you generated. Or remove the line entirely so our API will generate one for you
                    // label: "Optional string that replaces customer email"
                    onClose: function(){
                      Swal.fire({text: "Transaction Closed"});
                      $.ajax({
                          url: '/delete_unfinished/',
                          method: "POST",
                          data: {
                            phone: phonenumber,
                            amount: amount,
                            reference: ref,
                            csrfmiddlewaretoken: token,
                          },
                          success: function(response){
                              location.reload()
                          }
                        })
                      location.reload();
                      $('.checkout').prop('disabled', false);
                    },
                    callback: function(response){
                      Swal.fire({text: 'Click on continue to process your order', confirmButtonText: "Continue"}).then((result) => {
                        Swal.fire({text: "Processing your order."})
                        Swal.showLoading()
                        let token = $("input[name=csrfmiddlewaretoken]").val();
                        let reference = response.reference
                        $.ajax({
                          url: '/ishare/',
                          method: "POST",
                          data: {
                            phone: phonenumber,
                            amount: amount,
                            reference: reference,
                            csrfmiddlewaretoken: token,
                          },
                          success: function(response){
                            Swal.fire({text: response.status, icon:response.icon, confirmButtonText:"Okay"}).then((value) => {
                              location.reload()
                            })
                          }
                        })
                      })

                      //let x = document.createElement("INPUT")
                      //x.setAttribute("type", "hidden")
                      //x.setAttribute("name", "reference_field")
                      //x.setAttribute("value", reference)
                      //paymentForm.appendChild(x)
                      //paymentForm.submit();
                      $('.checkout').prop('disabled', false);
                    }
                  });

                  handler.openIframe();
                  }
                  else if (
                    result.dismiss === Swal.DismissReason.cancel
                  ){
                      $.ajax({
                          url: '/delete_unfinished/',
                          method: "POST",
                          data: {
                            phone: phonenumber,
                            amount: amount,
                            reference: ref,
                            csrfmiddlewaretoken: token,
                          },
                          success: function(response){
                              location.reload()
                          }
                        })
                  }

                })    

              }
            })


          
        }
    </script>
{% endblock %}
